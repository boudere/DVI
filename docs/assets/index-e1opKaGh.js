import{getAuth as C,GoogleAuthProvider as F,signInWithPopup as V}from"https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";import{initializeApp as z}from"https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";import{getFirestore as Y,setDoc as w,doc as S,serverTimestamp as W,getDoc as I,updateDoc as X}from"https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function s(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function e(i){if(i.ep)return;i.ep=!0;const a=s(i);fetch(i.href,a)}})();const l="DATA_INFO",x="PANTALLA_MANAGER",u="SCENE_MANAGER",g="DIALOGO_MANAGER",_="MINIJUEGO_MANAGER",y="CURSOR_MANAGER",E="LOGIN_SCENE",D="JuegoOveja",G="JuegoDiscoteca",M="SIGNAL_SCENE_CREATED";class b extends Phaser.Scene{constructor(t){super(t),this.isPause=!1,this.animations_finished=0,this.total_animations=0,this.scene_name=t.key}exit(){this.pause()}enter(t){return!!t}_update(){this.isPause}pause(){this.isPause=!0}unpause(){this.isPause=!1}sendSignal(t){}onSignal(t){}scene_created(){this.scene.get(u).events.emit(M,this.scene.key)}starting_animation(){}cursor_entered(t,s){this.scene.get(u).cursor_entered(t,s)}cursor_exited(t){this.scene.get(u).cursor_exited(t)}move(t,s,e){}play_music(t,s={}){this.scene.get(u).play_music(this.scene_name,t,s)}stop_music(t,s){this.scene.get(u).stop_music(t,s)}play_sfx(t,s={}){this.scene.get(u).play_sound(this.scene_name,t,s)}stop_sfx(t,s){this.scene.get(u).stop_sound(t,s)}}class j extends Phaser.GameObjects.Sprite{constructor(t,s,e,i,a,o,r){super(t,s,e,i),this._reset_varaibles(),this.setScale(a,o),r&&(this._set_events(),this.on_click=r),this._set_main_events(),this.on("destroy",this.before_destroy,this)}_reset_varaibles(){this.isPause=!1,this.mouse_over=!1,this.game_object_data={}}_add_sprite(t){this.scene.add.existing(this),t?this.start_animation(t):this.finish_animation()}async start_animation(t){this.scene.starting_animation();let s=this.animation.get_animation_data(t,this.game_object_data);for(const[e,i]of Object.entries(s)){const a=i.map(o=>this.run_tween(o));await Promise.all(a)}this.finish_animation()}run_tween(t){"alpha_start"in t&&(this.alpha=t.alpha_start),"scaleX_start"in t&&(this.scale=t.scaleX_start),"scaleY_start"in t&&(this.scale=t.scaleY_start),"pos_x_start"in t&&(this.x=t.pos_x_start),"pos_y_start"in t&&(this.y=t.pos_y_start);const s={};return"alpha_end"in t&&(s.alpha=t.alpha_end),"scaleX_end"in t&&(s.scale=t.scaleX_end),"scaleY_end"in t&&(s.scale=t.scaleY_end),"pos_x_end"in t&&(s.x=t.pos_x_end),"pos_y_end"in t&&(s.y=t.pos_y_end),new Promise(e=>{this.scene.tweens.add({targets:this,duration:t.duration||500,ease:t.ease||"Power2",...s,onComplete:()=>e()})})}finish_animation(){}exit(){this.visible=!1,this._remove_events()}enter(){this.visible=!0}_update(){return!this.isPause}pause(){this.mouse_over&&this._mouse_out(),this.disableInteractive()}unpause(){this.setInteractive()}_start_animation(){}_stop_animation(){}_set_events(){this.on("pointerdown",this._mouse_down,this),this.on("pointerup",this._mouse_up,this),this.on("pointermove",this._mouse_move,this)}_remove_events(){this._remove_main_events(),this.off("pointerdown",this._mouse_down,this),this.off("pointerup",this._mouse_up,this),this.off("pointermove",this._mouse_move,this)}_set_main_events(){this.on("pointerover",this._mouse_over,this),this.on("pointerout",this._mouse_out,this),this.on("pointerupoutside",this._mouse_out,this)}_remove_main_events(){this.off("pointerover",this._mouse_over,this),this.off("pointerout",this._mouse_out,this),this.off("pointerupoutside",this._mouse_out,this)}_mouse_enter(){return!this.isPause}_mouse_over(){let t=!1;return this.on_click&&(t=!0),this.nombre&&this.scene.cursor_entered(this.nombre,t),!t||this.isPause?!1:(this.mouse_over=!0,this.setTint(14477567),!0)}_mouse_out(){return this.isPause?!1:(this.mouse_over=!1,this.clearTint(),this.nombre&&this.scene.cursor_exited(this.nombre),!0)}_mouse_down(){return!this.isPause}_mouse_up(){return!this.isPause}_mouse_move(){return!this.isPause}before_destroy(){}}class P extends j{constructor(t,s,e,i,a){super(t,s,e,i,1,1),this.delauy=a}_reset_varaibles(){super._reset_varaibles()}finish_animation(){}exit(){this.musica.stop(),super.exit()}enter(){super.enter(),setTimeout(()=>{this._add_sprite(this.animation_data)},this.delay)}_update(){super.update()}pause(){super.pause()}unpause(){super.unpause()}_start_animation(){super._start_animation()}_stop_animation(){super._stop_animation()}_set_events(){super._set_events()}_remove_events(){super._remove_events()}_mouse_enter(){super._mouse_enter()}_mouse_over(){super._mouse_over()}_mouse_out(){super._mouse_out()}_mouse_down(){super._mouse_down()}_mouse_up(){super._mouse_up(),this.scene.signal_click(this.on_click)}_mouse_move(){super._mouse_move()}before_destroy(){super.before_destroy()}}class K extends Phaser.GameObjects.Text{constructor(t,s,e,i,a,o,r,h={}){let d={...{fontSize:"32px",fontFamily:"Arial",color:"#000000",align:"left",lineSpacing:10,wordWrap:{width:a-20}},...h};super(t,s,e,"",d),this._reset_varaibles(),this.texto=o,this.containter=i,this.setOrigin(0,0),this.setDepth(i.depth+1),this.on("destroy",this.before_destroy,this),setTimeout(()=>{this._add_text(!0)},r)}_reset_varaibles(){this.isPause=!1}_add_text(t){this.scene.add.existing(this),t?this.start_animation():this.finish_animation()}start_animation(){let t=0,s=this.texto,e="";this.setText(""),this.scene.time.addEvent({delay:30,callback:()=>{e+=s.charAt(t),this.setText(e),t++,t>=s.length&&this.containter.finish_animation()},repeat:s.length-1})}run_tween(t){}finish_animation(){}exit(){this.visible=!1}enter(){this.visible=!0}_update(){return!this.isPause}pause(){this.mouse_over&&this._mouse_out(),this.disableInteractive()}unpause(){this.setInteractive()}_start_animation(){this.scene.start_animation()}_stop_animation(){}_set_events(){}before_destroy(){}}class T extends K{constructor(t,s,e,i,a,o,r,h={}){super(t,s,e,i,a,o,r,h)}}class A{constructor(t){this.animation={},this.DURATION="duration",this.data_json=t.scene.get(l).get_data_json().Json,this.animation_data=t.scene.get(l).get_json(this.data_json.Animation)}get_animation_data(t,s){let e={};return Object.entries(s).forEach(([i,a])=>{e[i]=a}),Object.entries(t).forEach(([i,a])=>{this.animation[i]=[],Object.entries(e).forEach(([o,r])=>{s[o]=e[o]}),a.forEach(o=>{this.animation[i].push({});let r=this.animation[i].length-1;this.get_animation(e,t,i,r,s)})}),this.animation}get_animation(t,s,e,i,a){let o=this.animation_data[s[e][i].type];this.animation[e][i][this.DURATION]=s[e][i][this.DURATION],Object.entries(o).forEach(([r,h])=>{let m=this.translate_animation(h,e,i,s,a);this.animation[e][i][r]=m,this.animation[e][i][r]=m,r.endsWith("_end")&&(t[r.slice(0,-4)]=m)})}translate_animation(t,s,e,i,a){if(typeof t!="string")return t;const o=[];let r="",h=0,m="";for(;h<t.length;){let p=t[h];if(/\d/.test(p)){const{result:c,nextIndex:f}=this.readWhile(t,h,/\d/);o.push(parseInt(c)),h=f;continue}if(p==="{"){const{result:c,nextIndex:f}=this.readBetween(t,h+1,"}");m=c,h=f;continue}if(p==="["){const{result:c,nextIndex:f}=this.readBetween(t,h+1,"]");o.push({bracketsContent:c}),h=f;continue}if(p==="$"){const{result:c,nextIndex:f}=this.readWhile(t,h+1,/[^\s\{\}\[\]\$]/);o.push({variable:c}),h=f;continue}h++}r.trim()&&o.push(r.trim());let d=[];return o.forEach(p=>{if(Number.isInteger(p))d.push(p);else if(p.variable){let c=p.variable.split("_");c.pop(),c=c.join("_"),d.push(a[c])}else p.bracketsContent&&d.push(i[s][e].var[p.bracketsContent])}),d.length<2?d[0]:this.operation_animation(d[0],d[1],m)}readBetween(t,s,e){let i="",a=s;for(;a<t.length&&t[a]!==e;)i+=t[a],a++;return{result:i,nextIndex:a+1}}readWhile(t,s,e){let i="",a=s;for(;a<t.length&&e.test(t[a]);)i+=t[a],a++;return{result:i,nextIndex:a}}operation_animation(t,s,e){switch(e){case"add":return t+s;case"sub":return t-s;case"mul":return t*s;case"div":return t/s;default:console.log("No se ha encontrado la operacion: "+e);break}}}class $ extends P{constructor(t,s,e,i,a,o){super(t,s,e,i,200),this.SCALE=1.2,this.text=a,this.finished_animation=0,this.total_animations=0,this.game_object_data={alpha:this.alpha,scale:this.scale,pos_x:this.x,pos_y:this.y},o?(this.animation_data={animation_1:[{type:"fade_in",duration:400},{type:"scale_center",duration:400,var:{scale:this.SCALE}}]},this.animation=new A(this.scene,this.animation_data,1e3)):this.setScale(SCALE)}create(){this.on("destroy",this.before_destroy,this)}finish_animation(){if(this.total_animations==0){this._load_main_text();return}this.finished_animation++,this.finished_animation==this.total_animations&&this.scene.finish_animation()}setText(t){this.total_animations=0,this.finished_animation=0,this.text=t,this._load_main_text()}_load_main_text(){this.main_text&&this.main_text.destroy();let t=this.x-this.width/2-100,s=this.y-this.height/2;this.main_text=new T(this.scene,t,s,this,this.width*1.2,this.text,this.delay).setOrigin(0,0),this.total_animations++}before_destroy(){this.main_text&&this.main_text.destroy(),super.before_destroy()}}class q extends P{constructor(t,s,e,i,a,o,r){super(t,s,e,i,200),this.setOrigin(1,1),this.SCALE=1.2,this.text=a,this.next_text=o,this.finished_animation=0,this.total_animations=0,this.game_object_data={alpha:this.alpha,scale:this.scale,pos_x:this.x,pos_y:this.y},r?(this.animation_data={animation_1:[{type:"fade_in",duration:200},{type:"scale_up",duration:200,var:{scaleX:this.SCALE,scaleY:this.SCALE}}]},this.animation=new A(this.scene,this.animation_data,1e3)):this.setScale(this.SCALE)}finish_animation(){if(this.total_animations==0){this._load_main_text();return}this.finished_animation++,this.finished_animation==this.total_animations&&(this.finished_animation=0,this.scene.finish_animation())}setText(t){this.total_animations=0,this.finished_animation=0,this.text=t,this._load_main_text()}_load_main_text(){this.main_text&&this.main_text.destroy();let t=this.x-this.width/2-100,s=this.y-this.height/2;this.main_text=new T(this.scene,t-this.width/2,s-this.height/3,this,this.width*this.SCALE,this.text,this.delay,{fontSize:"32px"}).setOrigin(0,0),this.total_animations++}before_destroy(){super.before_destroy(),this.main_text&&this.main_text.destroy()}pause(){super.pause(),this._remove_events()}unpause(){super.unpause(),this._set_events()}_mouse_up(){this.on_click={scene:"dialogo",name:this.next_text},super._mouse_up()}}class Z extends P{constructor(t,s,e,i,a){super(t,s,e,i,a),this.finished_animation=0,this.total_animations=0,this.game_object_data={alpha:this.alpha,scaleX:this.scaleX,scaleY:this.scaleY,pos_x:this.x,pos_y:this.y},this.animation_data={animation_1:[{type:"fade_in",duration:400},{type:"move_right",duration:400,var:{pos_x:500}}]},this.animation=new A(this.scene,this.animation_data,1e3),this.total_animations++}finish_animation(){this.finished_animation++,this.finished_animation==this.total_animations&&(this.finished_animation=0,this.scene.finish_animation())}}class Q extends b{constructor(){super({key:g}),this.CUADRADO_DIALOGO="cuadrado_dialogo",this.BUTTON_CUADRADO_DIALOGO="boton_dialogo",this.BACKGROUND_DEPTH=0,this.PERSONAJE_DEPTH=1,this.CUADRADO_DIALOGO_DEPTH=3,this.PISO_MUSICA="tema_inicial"}_reset_data(){this.cuadrado_dialogo=null,this.main_text=null,this.dialogo_data_selected=null,this.npc="",this.buttons_index=0,this.buttons=[]}create(){this.data_info_scene=this.scene.get(l),this.dialogo_data=this.data_info_scene.get_json(this.data_info_scene.data_json.Dialogos),this.scene_created()}_load_dialogo(t){const{width:s,height:e}=this.sys.game.canvas;this.animation_finished=!1,this.animate?this._load_cuadrado_dialogo(s,e):this._set_main_text(),this.total_animations++,this._load_background(),this.animate&&(this._load_personaje(s,e),this.total_animations++),this.buttons&&this.buttons.forEach(i=>i.destroy()),this.dialogo_data_selected.opciones&&this._load_buttons(s,e)}exit(){super.exit(),this.cuadrado_dialogo&&(this.cuadrado_dialogo.visible=!1,this.cuadrado_dialogo.main_text.visible=!1),this.persoanje&&(this.persoanje.visible=!1),this.background&&(this.background.visible=!1),this._remove_events()}enter(t){super.enter(t)&&(this.play_music(this.PISO_MUSICA),this.dialogo_data_selected=this.dialogo_data[t],this.animate=this.dialogo_data_selected.npc!=this.npc,this.npc=this.dialogo_data_selected.npc,this.total_animations=0,this.finished_animation=0,this.buttons_index=0,this._load_dialogo(t),this.background.visible=!0,this.animate&&this.persoanje&&this.persoanje.enter(),this._set_events(),this.pause())}_update(){super.update()}pause(){super.pause()}unpause(){super.unpause()}starting_animation(){this.animation_finished=!1,this.pause()}finish_animation(){if(this.finished_animation++,this.finished_animation==1&&this.animate){this.cuadrado_dialogo.enter();return}if(this.dialogo_data_selected.opciones&&this.buttons_index<this.buttons.length){this.buttons[this.buttons_index].enter(),this.buttons_index++;return}this.finished_animation==this.total_animations&&(this.animation_finished=!0,this.dialogo_data_selected.opciones&&this.buttons.forEach(t=>t.unpause()),this.unpause())}signal_click(t){t.scene=="dialogo"?this.enter(t.name):this.scene.get(u).signal_click(t)}_load_background(){this.background&&this.background.destroy();let t=this.data_info_scene.get_img(g,this.dialogo_data_selected.fondo);this.background=this.add.image(0,0,t).setOrigin(0,0),this.background.setDepth(this.BACKGROUND_DEPTH)}_load_cuadrado_dialogo(t,s){this.cuadrado_dialogo&&this.cuadrado_dialogo.destroy();let e=this.data_info_scene.get_img(g,this.CUADRADO_DIALOGO);this.cuadrado_dialogo=new $(this,t/2,s-150,e,this.dialogo_data_selected.texto,!0),this.cuadrado_dialogo.setDepth(this.CUADRADO_DIALOGO_DEPTH)}_set_main_text(){this.cuadrado_dialogo.setText(this.dialogo_data_selected.texto)}_load_personaje(t,s){this.persoanje&&this.persoanje.destroy();let e=this.dialogo_data_selected.npc+"_"+this.dialogo_data_selected.pose,i=this.data_info_scene.get_img(g,e);this.persoanje=new Z(this,0,s-s/4,i,1e3),this.persoanje.setDepth(this.PERSONAJE_DEPTH)}_load_nombre_personaje(){this.dialogo_data_selected.personaje!="none"}_load_buttons(t,s){this.buttons=[];let e=this.data_info_scene.get_img(g,this.BUTTON_CUADRADO_DIALOGO),i=this.cuadrado_dialogo.x+this.cuadrado_dialogo.width/2*this.cuadrado_dialogo.SCALE,a=this.cuadrado_dialogo.y-this.cuadrado_dialogo.height/2*this.cuadrado_dialogo.SCALE;for(this.buttons_index=1;this.buttons_index<=3&&this.dialogo_data_selected["texto_"+this.buttons_index];){let o=new q(this,i,a,e,this.dialogo_data_selected["texto_"+this.buttons_index],this.dialogo_data_selected["opcion_"+this.buttons_index],!0);o.setDepth(this.CUADRADO_DIALOGO_DEPTH+1),this.buttons_index++,a-=o.height,this.buttons.push(o),this.total_animations++}this.buttons_index=0}_set_events(){this.input.on("pointerup",this._mouse_up,this)}_remove_events(){this.input.off("pointerup",this._mouse_up,this)}_mouse_up(){if(this.animation_finished&&!this.dialogo_data_selected.opciones)if(this.dialogo_data_selected.opcion_1!="FIN")this.enter(this.dialogo_data_selected.opcion_1);else{let t={scene:this.dialogo_data_selected.texto_1,name:this.dialogo_data_selected.opcion_2};this.scene.get(u).signal_click(t)}}}class tt extends j{constructor(t,s,e,i){super(t,s,e,i,1,1),this.scene.add.existing(this),this.create()}create(){this.name_text=new T(this.scene,this.x,this.y,this,this.width," ",0,{fontSize:"24px",align:"center"}).setOrigin(.5,.5),this.exit()}exit(){super.exit(),this.visible=!1,this.name_text.visible=!1,this.clearTint()}enter(t,s){super.enter(),this.visible=!0,this.name_text.visible=!0,this.name_text.setText(t),s||this.setTint(8947848)}_update(){super.update()}pause(){super.pause()}unpause(){super.unpause()}finish_animation(){}move(t,s){s+=this.height*2,this.x=t,this.y=s,this.name_text.x=t,this.name_text.y=s}}class st extends b{constructor(){super({key:y})}_reset_data(){}create(){this.scene_manager=this.scene.get(u),this._set_events(),this.movement_x=0,this.movement_y=0,this.can_move=!1,this.background=new tt(this,0,0,this.scene.get(l).get_img(y,"can_be_clicked")),this._set_events()}enter(t){this.edge_margin=t.edge_margin,this.move_speed=t.move_speed}_update(t,s){this.can_move&&this.scene_manager.move(this.movement_x*s,this.movement_y*s)}_set_events(){this.input.on("pointermove",this._mouse_move,this),this.input.on("pointerup",this._mouse_up,this)}_mouse_move(t){this.background.move(t.x,t.y);const s=this.edge_margin,e=this.move_speed;if(this.movement_x=0,this.movement_y=0,t.x<s){const i=(s-t.x)/s;this.movement_x=e*i}else if(t.x>this.sys.game.config.width-s){const i=(t.x-(this.sys.game.config.width-s))/s;this.movement_x=-e*i}if(t.y<s){const i=(s-t.y)/s;this.movement_y=e*i}else if(t.y>this.sys.game.config.height-s){const i=(t.y-(this.sys.game.config.height-s))/s;this.movement_y=-e*i}this.can_move=this.movement_x!==0||this.movement_y!==0}_mouse_up(){this.background.exit()}_load_background(){}cursor_entered(t,s){this.background.enter(t,s)}cursor_exited(t){this.background.exit(t)}}class R extends Phaser.Scene{constructor(t){super(t)}_update(t,s){}enter(){}exit(){}_set_event(t){}_remove_event(t){}game_created(){this.scene.get(_).game_created(this.scene.key)}start_game(){}finnish_game(){}}class v extends Phaser.Physics.Arcade.Sprite{constructor(t,s,e,i){let a=t.scene.get(l).get_img(_,i);super(t,s,e,a),this._add_img(),this._set_colliders(),this.visible=!1}enter(){this.visible=!0}exit(){this.destroy()}_update(t,s){}_set_event(t){}_remove_event(t){}_set_colliders(t=.8,s=.8){let e=this.width*t,i=this.height*s,a=this.width*(1-t)/2,o=this.height*(1-s)/2;this.body.setSize(e,i),this.body.setOffset(a,o)}_add_img(){this.scene.add.existing(this),this.scene.physics.add.existing(this)}}class et extends v{constructor(t,s,e,i,a){super(t,s,e,"oveja"),this.setScale(i,a)}enter(){super.enter(),setTimeout(()=>{this.setBounce(0),this.set_gravity_force(800),this.setVelocityX(-500)},10),this._set_colliders(.7,.7)}exit(){super.exit()}set_gravity_force(t){this.body.setGravityY(t)}_update(t,s){super._update(t,s)}_set_event(t){super._set_event(t)}_remove_event(t){super._remove_event(t)}}class it extends v{constructor(t,s,e){super(t,s,e,"valla"),this.body.setAllowGravity(!1)}enter(){super.enter(),this._set_colliders(.5,.7)}exit(){super.exit()}_update(t,s){super._update(t,s)}_set_event(t){super._set_event(t)}_remove_event(t){super._remove_event(t)}}class at extends v{constructor(t,s,e,i,a){super(t,s,e,"fondo"),this.setScale(i,a),this.setImmovable(!0),this.body.setAllowGravity(!1)}enter(){super.enter(),this._set_colliders(1,.4)}exit(){super.exit()}_update(t,s){super._update(t,s)}_set_event(t){super._set_event(t)}_remove_event(t){super._remove_event(t)}}class ot extends v{constructor(t,s,e,i,a){super(t,s,e,"cielo"),this.setScale(i,a),this.body.setAllowGravity(!1)}enter(){super.enter()}exit(){super.exit()}_update(t,s){super._update(t,s)}_set_event(t){super._set_event(t)}_remove_event(t){super._remove_event(t)}_set_colliders(t=.8,s=.8){}}class nt extends v{constructor(t,s,e,i,a){let o="prota1";super(t,s,e,o),this.PROTA_IMG=o,this.PROTA_IMG_2="prota2",this.setScale(i,a),this.body.setAllowGravity(!1),this.puntuacion=0}oveja_contada(t){let s=this.scene.data_info_scene.get_img(_,this.PROTA_IMG_2);this.setTexture(s),this.puntuacion=t,this.add_text(),setTimeout(()=>{t==this.puntuacion&&(s=this.scene.data_info_scene.get_img(_,this.PROTA_IMG),this.setTexture(s),this.destroy_text())},400)}add_text(){let t=this.x+28;this.puntuacion>10?t=this.x+25:this.puntuacion>100&&(t=this.x+20),this.texto=this.scene.add.text(t,this.y-80,`${this.puntuacion}`,{fontSize:"32px",fill:"#000000",fontFamily:"Impact"}).setOrigin(.5,.5),this.texto.setDepth(1)}destroy_text(){this.texto&&this.texto.destroy()}enter(){super.enter()}exit(){this.texto&&this.texto.destroy(),super.exit()}_update(t,s){super._update(t,s)}_set_event(t){super._set_event(t)}_remove_event(t){super._remove_event(t)}_set_colliders(t=.8,s=.8){}}class k extends Phaser.GameObjects.Sprite{constructor(t,s,e,i){super(t,s,e,i),this.setOrigin(0,0),this.setInteractive(),this.total_clicks=0,this.clicks=0}enter(t=null){this.scene.add.existing(this),this.total_clicks++,this._set_events()}exit(){this._remove_events(),this.destroy()}next_frame(){this.clicks++,this.clicks>=this.total_clicks&&(this.clicks=0,this.action())}action(){}_set_events(){this.on("pointerup",this._mouse_up,this)}_remove_events(){this.off("pointerup",this._mouse_up,this)}_mouse_up(){this.next_frame()}}class rt extends k{constructor(t,s,e,i){super(t,s,e,i)}action(){this.scene.start_game()}}let ht=class extends rt{constructor(t,s,e,i){super(t,s,e,i)}};class _t extends k{constructor(t,s,e,i){super(t,s,e,i)}action(){this.scene.finnish_game()}}class ct extends _t{constructor(t,s,e,i){super(t,s,e,i)}}class ut extends R{constructor(t){super({key:D}),t={PANTALLA_INCIO:"pantalla_inicio",PANTALLA_FINAL:"pantalla_final"},this.OVEJA_IMG=t.OVEJA_IMG,this.VALLA_IMG=t.VALLA_IMG,this.FONDO_IMG=t.FONDO_IMG,this.CIELO_IMG=t.CIELO_IMG,this.PANTALLA_INCIO=t.PANTALLA_INCIO,this.PANTALLA_FINAL=t.PANTALLA_FINAL,this.OVEJITA_MUSICA="ovejitas",this.started=!1,this.ovejas_contadas=0,this.oveja_contada=[]}create(){this.SCREEN_WIDTH=this.sys.game.canvas.width,this.SCREEN_HEIGHT=this.sys.game.canvas.height,this.data_info_scene=this.scene.get(l),this.persoanl_best=this.data_info_scene.get_json("saves").Minijuegos.JuegoOveja.RecortdPuntuacion,this.datos_usuario=this.data_info_scene.get_datos_usaurio().Minijuegos.JuegoOveja,this.persoanl_best=this.datos_usuario.RecortdPuntuacion,this.scene.get(_).play_music(this.OVEJITA_MUSICA),this.ovejas=[],this._crear_cielo(),this._crear_suelo(),this._crear_prota(),this._crear_valla(),this._crear_marcador(),this._crear_pantalla_inicio(),this._crear_pantalla_final(),this.cursors=this.input.keyboard.createCursorKeys(),this.ovejaGroup=this.physics.add.group(),this.physics.add.collider(this.ovejaGroup,this.suelo),this.physics.add.collider(this.ovejaGroup,this.valla,(t,s)=>{this.choque_function(s)}),this.input.on("pointerdown",()=>{if(this.started)for(let t=0;t<this.ovejas.length;t++){const s=this.ovejas[t];if(s&&s.body&&s.body.onFloor()){s.setVelocityY(-1e3);break}}}),this.game_created()}enter(){super.enter(),this.pantalla_inicio.enter()}start_game(){this.pantalla_inicio.exit(),this.cielo.enter(),this.suelo.enter(),this.prota.enter(),this.valla.enter(),this._crear_oveja(),this.schedule_next_oveja(),this.started=!0}finnish_game(){this.pantalla_final.exit(),this.persoanl_best<this.ovejas_contadas&&this.data_info_scene.guardar_puntuacion(this.scene.key,this.ovejas_contadas),this.exit()}_crear_cielo(){let t=0,s=0,e=this.SCREEN_WIDTH/768,i=this.SCREEN_HEIGHT/432;this.cielo=new ot(this,t,s,e,i).setOrigin(0,0)}_crear_suelo(){let t=this.SCREEN_WIDTH/2,s=this.SCREEN_HEIGHT*.95,e=this.SCREEN_WIDTH/450,i=this.SCREEN_HEIGHT*.3/338;this.suelo=new at(this,t,s,e,i)}_crear_oveja(){let t=this.SCREEN_WIDTH+100,s=this.SCREEN_HEIGHT*.78,e=.85,i=.85,a=new et(this,t,s,e,i);a.enter(),this.ovejas.push(a),this.ovejaGroup.add(a)}_crear_prota(){let t=650,s=this.SCREEN_HEIGHT*.65;this.prota=new nt(this,t,s,1,1)}_crear_valla(){let t=500,s=this.SCREEN_HEIGHT*.88-100;this.valla=new it(this,t,s)}_crear_pantalla_inicio(){let t=0,s=0,e=this.data_info_scene.get_img(_,this.PANTALLA_INCIO);this.pantalla_inicio=new ht(this,t,s,e)}_crear_pantalla_final(){let t=0,s=0,e=this.data_info_scene.get_img(_,this.PANTALLA_FINAL);this.pantalla_final=new ct(this,t,s,e)}_crear_marcador(){this.contadorTexto=this.add.text(this.SCREEN_WIDTH-50,50,`Ovejas: ${this.ovejas_contadas}`,{fontSize:"40px",fill:"#ffffff",fontFamily:"Impact"}).setOrigin(1,0).setDepth(1)}schedule_next_oveja(){let t=100,s=300;t=Math.max(500,1e3-this.ovejas_contadas*10),s=Math.max(1e3,1500-this.ovejas_contadas*20);const e=Phaser.Math.Between(t,s);this.time.delayedCall(e,()=>{this.started&&(this._crear_oveja(),this.schedule_next_oveja())})}_update(){if(this.started){this.ovejas.forEach(t=>{t&&t.x<this.valla.x&&!t.contada&&(t.contada=!0,this.oveja_contada.push(this.ovejas.shift()))});for(let t=this.oveja_contada.length-1;t>=0;t--){const s=this.oveja_contada[t];if(s.x<-50){s.exit(),s.destroy(),this.oveja_contada.splice(t,1);continue}s.body&&this.valla.x-this.valla.displayWidth&&!s._yaSumada&&(s._yaSumada=!0,this.ovejas_contadas++,this.contadorTexto.setText(`Ovejas: ${this.ovejas_contadas}`),this.prota.oveja_contada(this.ovejas_contadas))}}}choque_function(t){this.started=!1,t.setTint(16711680),this.physics.pause(),this.time.removeAllEvents(),this.scene.get(_).stop_music(this.OVEJITA_MUSICA);const s=this.add.text(this.SCREEN_WIDTH/2,this.SCREEN_HEIGHT/2,"¡Perdiste!",{fontSize:"96px",color:"#ff0000",fontFamily:"Impact"}).setOrigin(.5).setDepth(1);setTimeout(()=>{this.pantalla_final.enter(this.vallasSaltadas),this.prota.exit(),this.valla.exit(),this.cielo.destroy(),this.ovejas.forEach(e=>{e.exit()}),this.oveja_contada.forEach(e=>{e.exit()}),this.ovejaGroup.clear(!0,!0),this.suelo.exit(),this.contadorTexto.destroy(),s.destroy()},2e3)}}class lt extends v{constructor(t,s,e,i,a,o){super(t,s,e,i),this.setScale(a,o)}enter(){super.enter(),this.setGravityY(800),this.setBounce(0),this.setCollideWorldBounds(!0)}exit(){super.exit()}_update(t,s){super._update(t,s)}_set_event(t){super._set_event(t)}_remove_event(t){super._remove_event(t)}}class dt extends R{constructor(t){super({key:G}),t={PERSONA_IMG:"persona",OBSTACULO_IMG:"obstaculo",FONDO_IMG:"fondodisco"},this.PERSONA_IMG=t.PERSONA_IMG,this.OBSTACULO_IMG=t.OBSTACULO_IMG,this.FONDO_IMG=t.FONDO_IMG,this.DISCOTECA_MUSICA="disco",this.personawidth=1024,this.personaheight=1024,this.obstaculowidth=1024,this.obstaculoheight=1024,this.started=!1}create(){this.obstaculossaltados=0,this.SCREEN_WIDTH=this.sys.game.canvas.width,this.SCREEN_HEIGHT=this.sys.game.canvas.height,this.contadorTexto=this.add.text(this.SCREEN_WIDTH-50,50,`Puntuación: ${this.obstaculossaltados}`,{fontSize:"40px",fill:"#ffffff",fontFamily:"Impact"}).setOrigin(1,0).setDepth(1),this.data_info_scene=this.scene.get(l),this.musica=this.sound.add(this.data_info_scene.get_musica(this.DISCOTECA_MUSICA),{loop:!0,volume:1}),this.musica.play();let t=this.physics.add.sprite(0,0,this.data_info_scene.get_img(_,this.FONDO_IMG)).setOrigin(0,0);t.setScale(this.SCREEN_WIDTH/t.width,this.SCREEN_HEIGHT/t.height),t.setImmovable(!0),t.body.setAllowGravity(!1),this._crearPersona(),this.cursors=this.input.keyboard.createCursorKeys(),this.obstaculos=[],this.scheduleNextObstaculo(),this.game_created()}enter(){super.enter(),this.persona.enter(),this.started=!0}_crearPersona(){let t=175,s=this.SCREEN_HEIGHT*.5;this.persona=new lt(this,t,s,this.data_info_scene.get_img(_,this.PERSONA_IMG),200/this.personawidth,200/this.personaheight)}scheduleNextObstaculo(){const t=Phaser.Math.Between(1500,3e3);this.time.delayedCall(t,()=>{this.spawnObstaculo(),this.scheduleNextObstaculo()})}spawnObstaculo(){let t=300,s=350,e=this.SCREEN_WIDTH+100,i=100,a=this.SCREEN_HEIGHT-t-100,o=Phaser.Math.Between(i,a),r=o-t/2,h=this.SCREEN_HEIGHT-(o+t/2);this.tuboSuperior=this.physics.add.sprite(e,r/2,this.data_info_scene.get_img(_,this.OBSTACULO_IMG)).setScale(s/this.obstaculowidth,r/this.obstaculoheight),this.tuboSuperior.setFlipY(!0),this.tuboInferior=this.physics.add.sprite(e,o+t/2+h/2,this.data_info_scene.get_img(_,this.OBSTACULO_IMG)).setScale(s/this.obstaculowidth,h/this.obstaculoheight),this.tuboInferior.setVelocityX(-500),this.tuboInferior.setGravityY(-600),this.tuboSuperior.setVelocityX(-500),this.tuboSuperior.setGravityY(-600),this.tuboInferior.body.setSize(this.tuboInferior.width*.8,this.tuboInferior.height*.8),this.tuboInferior.body.setOffset(this.tuboInferior.width*.1,this.tuboInferior.height*.1),this.tuboSuperior.body.setSize(this.tuboSuperior.width*.8,this.tuboSuperior.height*.8),this.tuboSuperior.body.setOffset(this.tuboSuperior.width*.1,this.tuboSuperior.height*.1),this.physics.add.collider(this.persona,this.tuboInferior,()=>{this.persona.setTint(16711680),this.physics.pause(),this.time.removeAllEvents(),this.musica.stop(),this.add.text(this.SCREEN_WIDTH/2,this.SCREEN_HEIGHT/2,"¡Perdiste!",{fontSize:"96px",color:"#ff0000",fontFamily:"Impact"}).setOrigin(.5)}),this.physics.add.collider(this.persona,this.tuboSuperior,()=>{this.persona.setTint(16711680),this.physics.pause(),this.time.removeAllEvents(),this.musica.stop(),this.add.text(this.SCREEN_WIDTH/2,this.SCREEN_HEIGHT/2,"¡Perdiste!",{fontSize:"96px",color:"#ff0000",fontFamily:"Impact"}).setOrigin(.5)}),this.obstaculos.push({superior:this.tuboSuperior,inferior:this.tuboInferior,contado:!1})}_update(){this.started&&(this.persona.body.blocked.down&&this.persona.setVelocityY(0),Phaser.Input.Keyboard.JustDown(this.cursors.space)&&this.persona.setVelocityY(-600),this.obstaculos.forEach(t=>{const s=t.inferior;s.x<this.persona.x&&!t.contado&&(this.obstaculossaltados++,this.contadorTexto.setText(`Puntuación: ${this.obstaculossaltados}`),t.contado=!0),s.x<-s.width&&(t.superior.destroy(),t.inferior.destroy())}))}}class pt extends b{constructor(){super({key:_})}_reset_data(){this.current_minigame=null}create(){this.data_info_scene=this.scene.get(l),this.scene_created()}enter(t){super.enter(t)&&this.start_minigame(t)}exit(){super.exit()&&this.exit_minigame()}start_minigame(t){this.current_minigame&&this.current_minigame.scene.stop(),this.add_scene_minijuego(t,this.get_minijuego(t))}exit_minigame(){this.current_minigame&&(this.current_minigame.scene.stop(),this.current_minigame=null)}_update(){this.current_minigame&&this.current_minigame._update()}open_dialog(t){this.scene.get(g).enter(t)}game_created(){this.current_minigame.enter()}add_scene_minijuego(t,s){this.scene.get(t)&&this.scene.remove(t),this.scene.add(t,s,!1),this.scene.launch(t),this.current_minigame=this.scene.get(t)}get_minijuego(t){switch(t){case D:return ut;case G:return dt;default:return null}}}class N extends j{constructor(t,s,e,i,a,o,r,h,m,d){super(t,s,e,i,a,o,m),this.game_object_data={alpha:this.alpha,scaleX:this.scaleX,scaleY:this.scaleY,pos_x:this.x,pos_y:this.y},this.delay=r,this.anitmation_info=h,h&&(this.animation=new A(t)),this.nombre=d}_reset_varaibles(){super._reset_varaibles(),this.nombre="",this.on_click=null,this.animation=null}finish_animation(){this.scene.finish_animation()}exit(){super.exit()}enter(){super.enter(),setTimeout(()=>{this._add_sprite(this.anitmation_info)},this.delay)}_update(){super.update()}pause(){super.pause()}unpause(){super.unpause()}_start_animation(){super._start_animation()}_stop_animation(){super._stop_animation()}_set_events(){super._set_events()}_remove_events(){super._remove_events()}_mouse_enter(){super._mouse_enter()}_mouse_over(){super._mouse_over()}_mouse_out(){super._mouse_out()}_mouse_down(){super._mouse_down()}_mouse_up(){super._mouse_up(),this.scene.signal_click(this.on_click)}_mouse_move(){super._mouse_move()}before_destroy(){super.before_destroy()}}class mt extends N{constructor(t,s,e){const i=s.nombre,a=e[i],o={nombre:a.nombre,nombre_img:s.nombre_img??a.img,pose:s.pose??a.pose,x:s.pos_x??a.pos_x,y:s.pos_y??a.pos_y,size:s.size??a.size,delay:s.delay??a.delay,animation:s.hasOwnProperty("animation")?s.animation:a.animation,on_click:s.hasOwnProperty("on_click")?s.on_click:a.on_click};o.nombre_img=t.scene.get(l).get_img(x,o.nombre_img+"_"+o.pose),super(t,o.x,o.y,o.nombre_img,o.size,o.size,o.delay,o.animation,o.on_click,o.nombre)}}class ft extends N{constructor(t,s,e,i,a,o){super(t,s,e,i,1,1,0,null,a,o)}}class gt extends N{constructor(t,s,e,i,a,o){super(t,s,e,i,1,1,0,null,a,o)}}class xt{constructor(t,s){this.scene=t,this.extra_info=s,this.data_info_scene=this.scene.scene.get(l),this.data=this.data_info_scene.get_data_json(),this.data_json=this.data.Json;let e=this.data_info_scene.get_json(this.data_json.PantallaInfo);this.selected_pantalla_info=e[this.extra_info.pantalla.nombre]}cargar_fondo(){let t=this.data_info_scene.get_img(x,this.selected_pantalla_info.background);return this.scene.add.image(0,0,t).setOrigin(0,0)}cargar_puertas(){return this.cargar_elementos("puertas",ft)}cargar_objetos(){return this.cargar_elementos("objetos",gt)}cargar_elementos(t,s){let e=this.selected_pantalla_info[t]||{},i=this.extra_info.pantalla[t]||{},a=[];return Object.keys(e).forEach(o=>{let r=e[o],h=i[o]||{},m={...r,...h},{nombre:d,pos_x:p,pos_y:c,on_click:f}=m,J=this.data_info_scene.get_img(x,o),B=new s(this.scene,p,c,J,f,d);a.push(B)}),a}}class vt extends b{constructor(){super({key:x}),this.NOMBRE_MUSICA="tema_inicial",this.BACKGROUND_DEPTH=0,this.PUERTAS_DEPTH=1,this.OBJETOS_DEPTH=1,this.NPCS_DEPTH=2,this.PROTA_DEPTH=3,this._reset_variables(),this.interactuables_animations={},this.npcs_array=[],this.puertas=[],this.objetos=[]}_reset_variables(){this.offset_x=0,this.offset_y=0,this.can_move=!1,this.animation_finished=!1,this.total_animations=0,this.animations_finished=0,this.move_limit_x=0,this.move_limit_y=0}create(){this.data_info_scene=this.scene.get(l),this.data=this.data_info_scene.get_data_json(),this.data_json=this.data.Json,this.pantallas_data=this.data_info_scene.get_json(this.data_json.Pantallas),this.personajes_data=this.data_info_scene.get_json(this.data_json.PersonajesInfo),this.scene_created()}move(t,s){if(!this.animation_finished)return;let e=this.offset_x+t,i=this.offset_y+s;e=Phaser.Math.Clamp(e,-this.move_limit_x,this.move_limit_x),i=Phaser.Math.Clamp(i,-this.move_limit_y,this.move_limit_y);const a=e-this.offset_x,o=i-this.offset_y;this.offset_x=e,this.offset_y=i,a!==0&&(this.background&&(this.background.x+=a),this.prota&&(this.prota.x+=a),this.npcs_array.forEach(r=>r.x+=a),this.puertas&&this.puertas.forEach(r=>r.x+=a),this.objetos&&this.objetos.forEach(r=>r.x+=a)),o!==0&&(this.background&&(this.background.y+=o),this.prota&&(this.prota.y+=o),this.npcs_array.forEach(r=>r.y+=o),this.puertas&&this.puertas.forEach(r=>r.y+=o),this.objetos&&this.objetos.forEach(r=>r.y+=o))}_load_pantalla(t){this.pantalla_data=this.pantallas_data[t],this.creador_pantalla=new xt(this,this.pantalla_data),this.sys.game.canvas,this._load_background(),this._load_npcs(),this._load_prota(),this._load_puertas(),this._load_objetos()}exit(){super.exit(),this.prota&&this.prota.exit(),this.background&&this.background.destroy(),this.npcs_array.forEach(t=>{t.exit()}),this.puertas.forEach(t=>{t.exit()}),this.objetos.forEach(t=>{t.exit()})}enter(t){super.enter(t)&&(this.play_music(this.NOMBRE_MUSICA),this._reset_variables(),this._load_pantalla(t),this.move_limit_x=(this.background.displayWidth-this.sys.game.canvas.width)/2,this.move_limit_y=(this.background.displayHeight-this.sys.game.canvas.height)/2,this.animation_finished=!0,this.move(-this.move_limit_x,-this.move_limit_y),this.animation_finished=!1,this.offset_x=0,this.offset_y=0,this.pause())}_update(t,s){super._update()}pause(){super.pause(),this.prota&&this.prota.pause(),this.npcs_array.forEach(t=>{t.pause()})}unpause(){super.unpause(),this.prota&&this.prota.unpause(),this.npcs_array.forEach(t=>{t.unpause()}),this.puertas.forEach(t=>{t.unpause()}),this.objetos.forEach(t=>{t.unpause()})}starting_animation(){this.pause()}finish_animation(){this.animations_finished++,this.animations_finished==this.total_animations&&(this.animation_finished=!0,this.unpause())}signal_click(t){t.scene=="pantalla"?(this.exit(),this.enter(t.name)):this.scene.get(u).signal_click(t)}_load_background(){this.background=this.creador_pantalla.cargar_fondo(),this.background.setDepth(this.BACKGROUND_DEPTH)}_load_npcs(){this.npcs_array.length>0&&this.npcs_array.forEach(s=>{s.destroy()}),this.npcs_array=[];let t=this.pantalla_data.npcs;Object.keys(t).forEach(s=>{this.npcs_array.push(this._load_personaje(t[s])),this.npcs_array[this.npcs_array.length-1].setDepth(this.NPCS_DEPTH),this.npcs_array[this.npcs_array.length-1].enter()})}_load_prota(){this.prota=this._load_personaje(this.pantalla_data.prota),this.prota.setDepth(this.PROTA_DEPTH),this.prota.enter()}_load_personaje(t){return this.total_animations++,new mt(this,t,this.personajes_data)}_load_puertas(){this.puertas&&this.puertas.forEach(t=>{t.destroy()}),this.puertas=this.creador_pantalla.cargar_puertas(),this.puertas.forEach(t=>{t.setDepth(this.PUERTAS_DEPTH),t.enter(),this.total_animations++})}_load_objetos(){this.objetos&&this.objetos.forEach(t=>{t.destroy()}),this.objetos=this.creador_pantalla.cargar_objetos(),this.objetos.forEach(t=>{t.setDepth(this.OBJETOS_DEPTH),t.enter(),this.total_animations++})}}const yt={apiKey:"AIzaSyCL31kN-RfrF8CiPhiPnxZmGmfYVUI3tV4",authDomain:"bitbybit-43aee.firebaseapp.com",projectId:"bitbybit-43aee",storageBucket:"bitbybit-43aee.firebasestorage.app",messagingSenderId:"494311902150",appId:"1:494311902150:web:0e6b80bc1889ca702dc0c7"},H=z(yt),bt=C(H),O=Y(H),Et=new F;async function St(){try{return(await V(bt,Et)).user}catch(n){return console.error("❌ Error al iniciar sesión:",n),null}}async function L(n,t){try{await w(S(O,"progresos",n),{...t,actualizado:W()})}catch(s){console.error("❌ Error al guardar:",s)}}async function U(n){try{const t=S(O,"progresos",n),s=await I(t);return s.exists()?s.data():(console.log("⚠️ No hay progreso guardado aún."),null)}catch(t){return console.error("❌ Error al cargar:",t),null}}async function At(n,t){const s=S(O,"rankings","record_minijuegos");try{(await I(s)).exists()?await X(s,{[n]:t}):await w(s,{Minijuegos:{[n]:t}})}catch(e){console.error("❌ Error al guardar ranking:",e)}}async function Ot(){try{const n=S(O,"rankings","record_minijuegos"),t=await I(n);return t.exists()?t.data()||null:(console.log("⚠️ No hay ranking guardado aún."),null)}catch(n){return console.error("❌ Error al cargar ranking:",n),null}}class It extends Phaser.Scene{constructor(){super(E)}async create(){const t=this.cameras.main.centerX,s=this.cameras.main.centerY;this.texto1=this.add.text(t,s-100,"Inicia sesión con Google",{fontSize:"32px",color:"#ffffff"}).setOrigin(.5),this.loginButton=this.add.rectangle(t,s,300,60,4359668).setInteractive({useHandCursor:!0}).on("pointerdown",async()=>this.iniciarSesion()),this.texto2=this.add.text(t,s,"Google Login",{fontSize:"24px",color:"#ffffff"}).setOrigin(.5),C().onAuthStateChanged(async e=>{e&&await this.cargarProgresoYEntrar(e)}),this.events.once(Phaser.Scenes.Events.SHUTDOWN,this.shutdown,this)}async iniciarSesion(){const t=await St();t?await this.cargarProgresoYEntrar(t):this.mostrarError("Inicio de sesión cancelado o fallido")}async cargarProgresoYEntrar(t){const s=t.uid;let e=await U(s);e||(e={Saves:{Pantalla:"demo_salon_1",Dialogo:"tutorial1",Minijuegos:{JuegoOveja:{RecortdPuntuacion:-2}}}},await L(s,e)),this.scene.get(u).agregar_scenes({userId:s,displayName:t.displayName,progreso:e})}mostrarError(t){const s=this.cameras.main.centerX;this.texto3=this.add.text(s,500,t,{fontSize:"20px",color:"#ff5555"}).setOrigin(.5)}shutdown(){this.texto1.destroy(),this.texto2.destroy(),this.texto3&&this.texto3.destroy(),this.loginButton.removeAllListeners("pointerdown"),this.loginButton.destroy()}}class jt{constructor(t){this.scene=t,this.currentMusic=null,this.musicVolume=1,this.sfxVolume=1,this.activesfx=[],this.data_info_scene=t.scene.get(l)}play_music(t,s={}){const e=this.data_info_scene.get_musica(t);if(this.currentMusic&&console.log("play_music",t,e,this.currentMusic.key,this.currentMusic.isPlaying,s),this.currentMusic&&this.currentMusic.key===e&&this.currentMusic.isPlaying)return;this.currentMusic&&this.currentMusic.stop();const i={loop:!0,volume:this.musicVolume,...s};this.currentMusic=this.scene.sound.add(e,i),this.currentMusic.play()}stop_music(){this.currentMusic&&(this.currentMusic.stop(),this.currentMusic=null)}set_music_volume(t){this.musicVolume=Phaser.Math.Clamp(t,0,1),this.currentMusic&&this.currentMusic.setVolume(this.musicVolume)}play_sfx(t,s={}){const e={volume:this.sfxVolume,...s},i=this.scene.sound.add(this.data_info_scene.get_musica(t),e);return i.play(),this.activesfx.push(i),i.once("complete",()=>{this.activesfx=this.activesfx.filter(a=>a!==i),i.destroy()}),i}stop_all_sfx(){this.activesfx.forEach(t=>{t.stop(),t.destroy()}),this.activesfx=[]}set_sfx_volume(t){this.sfxVolume=Phaser.Math.Clamp(t,0,1),this.activesfx.forEach(s=>{s.setVolume(this.sfxVolume)})}}class Pt extends b{constructor(){super({key:u}),this.scenes={},this.currentScene=null,this.currentSceneData=null,this.cursor_data={edge_margin:200,move_speed:1}}create(){this.audio_manager=new jt(this),this.data_info_scene=this.scene.get(l),this.data=this.data_info_scene.get_data_json(),this.data_json=this.data.Json,this.saves_data=this.data_info_scene.get_json(this.data_json.Saves),this.scene.add(E,It,!1),this.scene.launch(E)}agregar_scenes(t){this.scene.stop(E),this.data_info_scene.save_firestore_data(t),this.events.on(M,this.scene_created,this),this.add_scene(x,vt),this.add_scene(g,Q),this.add_scene(_,pt,"JuegoOveja"),this.add_scene(y,st),this.cursor=this.scenes[y],this.cursor.enter(this.cursor_data)}add_scene(t,s,e=null){this.scene.get(t)&&this.scene.remove(t),this.scene.add(t,s,!1),this.scene.launch(t),this.scenes[t]=this.scene.get(t),e&&(this.currentScene=t,this.currentSceneData=e)}signal_click(t){this.scenes[this.currentScene].exit(),this.currentScene=this._get_next_scene(t.scene),this.scenes[this.currentScene].enter(t.name)}scene_created(t){t==this.currentScene?this.scenes[t].enter(this.currentSceneData):this.scenes[t].exit()}_get_next_scene(t){switch(t){case"dialogo":return g;case"pantalla":return x;case"minijuego":return _}}cursor_entered(t,s){this.cursor.cursor_entered(t,s)}cursor_exited(t){this.cursor.cursor_exited(t)}move(t,s){this.scenes[this.currentScene].move(t,s)}exit(){this.pause()}enter(t){this.unpause()}update(t,s){this.currentScene&&(this.scenes[this.currentScene]._update(t,s),this.cursor._update(t,s))}_update(){super.update()}pause(){super.pause()}unpause(){super.unpause()}play_music(t,s,e={}){t==this.currentScene&&this.audio_manager.play_music(s,e)}stop_music(t){t==this.currentScene&&this.audio_manager.stop_music()}set_music_volume(t,s){t==this.currentScene&&this.audio_manager.set_music_volume(s)}play_sfx(t,s,e={}){t==this.currentScene&&this.audio_manager.play_sfx(s,e)}stop_all_sfx(t){t==this.currentScene&&this.audio_manager.stop_all_sfx()}set_sfx_volume(t,s){t==this.currentScene&&this.audio_manager.set_sfx_volume(s)}}class Tt extends Phaser.Scene{constructor(){super({key:l,active:!0}),this.ROOT="/DVI/",this.ASSETS_PATH=this.ROOT+"assets/",this.JSON_PATH=this.ASSETS_PATH+"json/",this.IMG_PATH=this.ASSETS_PATH+"img/",this.json_data="json_data",this.data_name="data.json",this.asdasd=0}preload(){this.load.json(this.json_data,this.JSON_PATH+this.data_name)}create(){this.data=this.cache.json.get(this.json_data).Assets,this.data_json=this.data.Json,this.data_imgs=this.data.Imgs,this.data_musica=this.data.Musica,this.ROOT=this.data.Root,this.ASSETS_PATH=this.ROOT+this.data.Path,this.JSON_PATH=this.ASSETS_PATH+this.data_json.Path,this.IMG_PATH=this.ASSETS_PATH+this.data_imgs.Path,this.MUSICA_PATH=this.ASSETS_PATH+this.data_musica.Path,this.json_prefix=this.data_json.Prefix,this.img_prefix=this.data_imgs.Prefix,this.musica_prefix=this.data_musica.Prefix;let t=this.data_json.Folders;this.load.on("filecomplete",()=>{this.loaded||(this.loaded=!0,this.crear_laoding_screen(),this.get_number_assets(),this.load_assets())}),this.load.json(this.json_prefix+t,this.JSON_PATH+t+this.data_json.Suffix),this.load.start()}crear_laoding_screen(){const{width:t,height:s}=this.scale;this.loading_box=this.add.graphics(),this.loading_box.fillStyle(2236962,.8),this.loading_box.fillRect(t/2-t/4,s/2-20,t/2,200),this.loading_bar=this.add.graphics(),this.bar_x=t/2-t/4+10,this.bar_y=s/2-10,this.bar_width=t/2-20,this.bar_height=180}get_number_assets(){const t=this.cache.json.get(this.json_prefix+this.data_json.Folders);this.number_assets=this.get_number_assets_recursive(t),this.loaded_assets=0}get_number_assets_recursive(t){let s=0;return t.folders.forEach(e=>{s+=this.get_number_assets_recursive(e)}),s+=t.files.length,s}update_loading_bar(t){this.loading_bar.clear(),this.loading_bar.fillStyle(16777215,1),this.loading_bar.fillRect(this.bar_x,this.bar_y,this.bar_width*t,this.bar_height)}load_assets(){this.load.on("progress",t=>{this.update_loading_bar(t)}),this.load.on("complete",()=>{setTimeout(()=>{this.scene.start(u)},100)}),this.load_jsons(),this.load_imgs(),this.load_musicas(),this.load.start()}load_jsons(){this.data_json.Jsons.forEach(s=>{this.load_json(s)})}load_json(t){const s=this.data_json.Suffix;this.load.json(this.json_prefix+t,this.JSON_PATH+t+s)}get_data_json(){return this.cache.json.get(this.json_data).Assets}get_json(t){let s=t.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join("");return this.cache.json.get(this.json_prefix+t)[s]}load_imgs(){this.data_imgs.Clases.forEach(s=>{this.data_imgs[s].Clases.forEach(i=>{this.data_imgs[s][i][i].forEach(o=>{this.laod_img(s,i,o)})})})}laod_img(t,s,e){let i="";switch(s){case"Backgrounds":i=this.data_imgs[t].Path+this.data_imgs[t][s].Path+e+"/",this.load_img2(t,e,i);break;case"Personajes":this.data_imgs[t][s].Poses.forEach(r=>{i=this.data_imgs[t].Path+this.data_imgs[t][s].Path+e+"/",this.load_img2(t,e+"_"+r,i)});break;case"JuegoOveja":case"JuegoDiscoteca":case"Dialogos":case"Cursors":i=this.data_imgs[t].Path+this.data_imgs[t][s].Path,this.load_img2(t,e,i);break;case"Puertas":this.data_imgs[t][s].Lados.forEach(r=>{i=this.data_imgs[t].Path+this.data_imgs[t][s].Path+e+"/",this.load_img2(t,e+"_"+r,i)});break;case"Objetos":i=this.data_imgs[t].Path+this.data_imgs[t][s].Path,this.load_img2(t,e,i);break;default:console.log("Clase no encontrada",t,s,e);break}}load_img2(t,s,e){const i=this.data_imgs.Suffix;this.load.image(this.img_prefix+t+"_"+s,this.IMG_PATH+e+s+i)}load_musicas(){this.data_musica.Musicas.forEach(s=>{this.load_musica(s)})}load_musica(t){const s=this.data_musica.Suffix;this.load.audio(this.musica_prefix+t,this.MUSICA_PATH+t+s)}get_musica(t){return this.musica_prefix+t}get_img(t,s){let e="";switch(t){case x:case"Pantallas":e="Pantallas";break;case g:case"Dialogos":e="Dialogos";break;case _:case"Minijuegos":e="Minijuegos";break;case y:case"Cursors":e="Cursors";break}return this.img_prefix+e+"_"+s}save_firestore_data(t){this.userId=t.userId,this.userName=t.displayName,this.progreso=t.progreso,this.cargar_datos_usuario(),this.cargar_rankings()}guardar_puntuacion(t,s){if(!this.userId||!this.progreso){console.error("⚠️ No hay sesión activa o progreso cargado.");return}if(this.progreso.Saves||(this.progreso.Saves={}),this.progreso.Saves.Minijuegos||(this.progreso.Saves.Minijuegos={}),!this.progreso.Saves.Minijuegos[t]){this.progreso.Saves.Minijuegos[t]={RecortdPuntuacion:s};return}const e=this.progreso.Saves.Minijuegos[t].RecortdPuntuacion;s<=e||(this.progreso.Saves.Minijuegos[t].RecortdPuntuacion=s,L(this.userId,this.progreso),this.actualizar_ranking(t,s))}cargar_datos_usuario(){if(!this.userId){console.error("⚠️ No hay sesión activa.");return}U(this.userId).then(t=>{t?this.progreso=t:console.error("⚠️ No se encontraron datos para el usuario.")}).catch(t=>{console.error("❌ Error al cargar datos:",t)})}cargar_rankings(){if(!this.userId){console.error("⚠️ No hay sesión activa.");return}Ot().then(t=>{t?(this.ranking=t,this.ranking):console.error("⚠️ No se encontraron rankings para el usuario.")}).catch(t=>{console.error("❌ Error al cargar rankings:",t)})}get_datos_usaurio(){return this.progreso.Saves}get_ranking(t){return this.ranking[t]||null}async actualizar_ranking(t,s){if(!this.userId||!this.ranking){console.error("⚠️ No hay sesión activa o ranking cargado.");return}this.ranking[t]||(console.log("⚠️ No existía ranking para",t),this.ranking[t]=[]);let e=this.ranking[t];e=e.filter(r=>r.Nombre!==this.userName),e.push({Nombre:this.userName,Puntuacion:s}),e.sort((r,h)=>h.Puntuacion-r.Puntuacion);const i=e.slice(0,10),a=JSON.stringify(this.ranking[t]),o=JSON.stringify(i);a!==o&&(this.ranking[t]=i,await At(t,i))}}const Nt={width:1820,height:1358,parent:"juego",physics:{default:"arcade",arcade:{gravity:{y:600},debug:!0}},scene:[Tt,Pt],scale:{mode:Phaser.Scale.EXACT_FIT,autoCenter:Phaser.Scale.CENTER_BOTH}};new Phaser.Game(Nt);
